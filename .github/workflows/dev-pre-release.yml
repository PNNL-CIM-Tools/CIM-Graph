---
name: Pre-Release Package

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      force:
        description: 'Force deploy'
        required: false
        default: false
        type: boolean
jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      any_changed: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **.py
  build:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.any_changed == 'true' || github.event.inputs.force == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Bump version
        id: bump-version
        run: |
          echo "Bumping version..."

          # Get current version
          CURRENT_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "From: $CURRENT_VERSION"

          # Parse version and bump prerelease
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          PATCH_AND_PRE="${VERSION_PARTS[2]}"

          # Check if already a prerelease
          if [[ $PATCH_AND_PRE == *"a"* ]]; then
            # Extract patch and prerelease number
            PATCH="${PATCH_AND_PRE%%a*}"
            PRE="${PATCH_AND_PRE##*a}"
            NEW_PRE=$((PRE + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}a${NEW_PRE}"
          else
            # First prerelease
            PATCH="$PATCH_AND_PRE"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}a0"
          fi

          echo "To: $NEW_VERSION"

          # Update pyproject.toml
          sed -i "s/version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" pyproject.toml

          NEW_TAG="v${NEW_VERSION}"
          echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV

      - name: Build package
        run: |
          uv build

      - name: Commit bumped version
        run: |
          git config --global user.name 'gridappsd[bot]'
          git config --global user.email 'gridappsd[bot]@users.noreply.github.com'
          NEW_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          git commit -am "Bump version to $NEW_VERSION"
          git push origin develop

      - name: Create Release
        uses: ncipollo/release-action@v1.15.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          artifacts: "dist/*.gz,dist/*.whl"
          artifactErrorsFailBuild: true
          generateReleaseNotes: true
          commit: ${{ github.ref }}
          prerelease: true
          tag: ${{ env.NEW_TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Publish to PyPI
        id: publish-to-pypi
        run: |
          uv publish --token ${{ secrets.PYPI_TOKEN }}
