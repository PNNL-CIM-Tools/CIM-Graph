---
name: Release Package

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force:
        description: 'Force deploy'
        required: false
        default: false
        type: boolean

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      any_changed: ${{ steps.changed-files.outputs.any_changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **.py

  build:
    runs-on: ubuntu-latest
    needs: check-changes
    if: needs.check-changes.outputs.any_changed == 'true' || github.event.inputs.force == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Finalize version
        id: finalize-version
        run: |
          echo "Finalizing version..."

          # Get current version
          CURRENT_VERSION=$(uv run python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")
          echo "From: $CURRENT_VERSION"

          # Strip prerelease suffix if present (e.g., 0.4.3a8 -> 0.4.3)
          if [[ $CURRENT_VERSION =~ ^([0-9]+\.[0-9]+\.[0-9]+)(a|b|rc)[0-9]+$ ]]; then
            NEW_VERSION="${BASH_REMATCH[1]}"
            echo "Stripping prerelease suffix"
          else
            # Already a stable version, no change needed
            NEW_VERSION="$CURRENT_VERSION"
            echo "Already a stable version"
          fi

          echo "To: $NEW_VERSION"

          # Update pyproject.toml
          sed -i "s/version = \"$CURRENT_VERSION\"/version = \"$NEW_VERSION\"/" pyproject.toml

          NEW_TAG="v${NEW_VERSION}"
          echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV
          echo "NEW_VERSION=${NEW_VERSION}" >> $GITHUB_ENV

      - name: Build package
        run: |
          uv build

      - name: Commit finalized version
        run: |
          git config --global user.name 'gridappsd[bot]'
          git config --global user.email 'gridappsd[bot]@users.noreply.github.com'
          git commit -am "Release version ${{ env.NEW_VERSION }}"
          git push origin main

      - name: Create Release
        uses: ncipollo/release-action@v1.15.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          artifacts: "dist/*.gz,dist/*.whl"
          artifactErrorsFailBuild: true
          generateReleaseNotes: true
          commit: ${{ github.ref }}
          prerelease: false
          tag: ${{ env.NEW_TAG }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        id: publish-to-pypi
        run: |
          uv publish --token ${{ secrets.PYPI_TOKEN }}
