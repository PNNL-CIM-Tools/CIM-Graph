%%{init: {"theme":"base"}}%%
sequenceDiagram
    actor User
    participant GraphModel
    participant ConnectionInterface
    participant ThreadPoolExecutor
    participant SPARQL Queries
    participant Database
    note right of User: Expands knowledge graph

    User ->>+ GraphModel: get_all_edges(cim_class)
    GraphModel ->>+ ConnectionInterface: get_all_edges(graph, cim_class)
    ConnectionInterface ->> ConnectionInterface: Create uuid_list from graph[cim_class]
    ConnectionInterface ->> ConnectionInterface: Split uuid_list into batches of 100
    ConnectionInterface ->>+ ThreadPoolExecutor: Create executor with cpu_count workers
    
    loop For each batch of uuids
        ThreadPoolExecutor ->> ThreadPoolExecutor: Submit process_batch(batch)
        activate ThreadPoolExecutor
        note right of ThreadPoolExecutor: process_batch function
        ThreadPoolExecutor ->>+ SPARQL Queries: get_all_edges_sparql(graph, cim_class, batch)
        SPARQL Queries -->>- ThreadPoolExecutor: str[query text]
        ThreadPoolExecutor ->>+ Database: execute(query_text)
        Database -->>- ThreadPoolExecutor: json[query response]
        ThreadPoolExecutor ->> ConnectionInterface: edge_query_parser(query_output, graph, cim_class)
        deactivate ThreadPoolExecutor
    end
    
    ConnectionInterface ->> ThreadPoolExecutor: Wait for all futures to complete
    ThreadPoolExecutor -->>- ConnectionInterface: All batches processed
    ConnectionInterface -->>- GraphModel: None
    GraphModel -->- User: None